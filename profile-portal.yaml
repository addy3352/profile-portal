domains:
- domain: portal.aditya-raman.com
  type: PRIMARY

envs:
- key: VITE_API_BASE
  scope: RUN_AND_BUILD_TIME
  value: https://mesh.aditya-raman.com
- key: VITE_HEALTH_PASS
  scope: RUN_AND_BUILD_TIME
  type: SECRET
- key: MESH_API_KEY_HEALTH
  scope: RUN_AND_BUILD_TIME
  type: SECRET
- key: AGENT_HEALTH_KEY
  scope: RUN_AND_BUILD_TIME
  type: SECRET

features:
- buildpack-stack=ubuntu-22

# ==========================================
# ROUTING RULES (Order matters! Most specific first)
# ==========================================
ingress:
  rules:
  # Rule 1: Proxy /mcp/* to mesh server (MUST come first - most specific)
  - component:
      name: mesh-proxy
      preserve_path_prefix: true
    match:
      path:
        prefix: /mcp
    cors:
      allow_origins:
      - exact: https://portal.aditya-raman.com
      allow_methods:
      - GET
      - POST
      - OPTIONS
      allow_headers:
      - Content-Type
      - Authorization
      - X-API-KEY
      
  # Rule 2: Serve static site for everything else (catch-all - least specific)
  - component:
      name: profile-ui
      preserve_path_prefix: true
    match:
      path:
        prefix: /

name: profile-portal
region: blr

# ==========================================
# COMPONENTS
# ==========================================

# Proxy component for mesh API
services:
- name: mesh-proxy
  http_port: 80
  instance_count: 1
  instance_size_slug: basic-xxs
  envs:
  - key: API_KEY
    type: SECRET # AGENT_HEALTH_KEY
  dockerfile_path: proxy/Dockerfile.proxy
  source_dir: .
  github:
    branch: main
    deploy_on_push: true
    repo: addy3352/profile-portal

# Static site component (your React app)
static_sites:
- name: profile-ui
  build_command: npm ci && npm run build
  output_dir: dist
  source_dir: /
  github:
    branch: main
    deploy_on_push: true
    repo: addy3352/profile-portal
  envs:
  - key: VITE_HEALTH_PASS
    scope: BUILD_TIME
    type: SECRET
  - key: VITE_MCP_URL
    scope: BUILD_TIME
    value: /mcp
  - key: NODE_VERSION
    scope: BUILD_TIME
    value: "20"

  - key: AGENT_HEALTH_KEY
    scope: BUILD_TIME
    type: SECRET
  - key: AGENT_IRIS_KEY
    scope: BUILD_TIME
    type: SECRET
  - key: MESH_API_KEY_HEALTH
    scope: BUILD_TIME
    type: SECRET
  - key: VITE_HEALTH_PASS
    scope: BUILD_TIME
    type: SECRET